<div>
  <%= button_to "Edit Product", [:edit, @product.vendor, @product], :method => :get, :class => "btn btn-default pull-right" %>
  <h1><%= @product.name %></h1>

  <div class="row">
    <div class = 'col-sm-6'>
      <h2>Current Test Status</h2>
      <table class="table table-hover table-condensed">
        <% certifications(@product).each do |c, certification| %>
          <% certification['tests'].each do |cert_test| %>
          <tr>
            <% unless cert_test != certification['tests'][0] %>
            <th rowspan="<%= certification['tests'].length %>"><%= "#{c}" %></th>
            <% end %>
            <td><%= APP_CONFIG.tests[cert_test]['title'] %></td>
            <td><%= status_by_test(@product)[cert_test][c] %></td>
          </tr>
          <% end %>
        <% end %>
      </table>
    </div>

    <div class = 'col-sm-6'>
      <h2>Product Information</h2>
      <%= render partial: 'product_summary', locals: { product: @product } %>
    </div>
  </div>

  <% unless @product.product_tests.empty? %>
    <div class = 'panel panel-default'>
      <div class = 'panel-heading'>
        <h3>Download Full Test Deck</h3>
      </div>
      <div class = 'panel-body'>
        <p>This download contains a folder for each measure selected for this product. Inside these folders are XML documents for each patient associated with that measure.</p>
        <% num_measure_tests = @product.product_tests.measure_tests.count %>
        <% num_measure_tests_ready = @product.product_tests.measure_tests.where(state: :ready).count %>
        <% if num_measure_tests_ready == num_measure_tests %>
          <%= form_for @product, url: { controller: 'records', action: 'download_full_test_deck' }, :html => { :method => 'GET' } do |f| %>
            <%= button_tag(type: 'submit', class: 'btn btn-primary') do %>
              <i class = 'fa fa-fw fa-download'></i> Download All Patients (.zip)
            <% end %>
          <% end %>
        <% else %>
          <p>test deck is loading. refresh your browser periodically</p>
          <p><%= "#{num_measure_tests_ready} of #{num_measure_tests} ready" %></p>
        <% end %>
      </div>
    </div>
  <% end %>

  <div class="product-test-tabs">
    <ul>
      <% APP_CONFIG.tests.each do |c, certification_test| %>
        <% if certification_test['certifications'] & certifications(@product).keys() %>
          <li><a href="#<%= "#{c}" %>"><%= "#{certification_test['title']}" %></a></li>
        <% end %>
      <% end %>
    </ul>

    <% APP_CONFIG.tests.each do |c, certification_test| %>
      <% if certification_test['certifications'] & certifications(@product).keys() %>
        <div id="<%= c %>">
          <h3><%# certification_test['title'] %></h3>
          <p><%= certification_test['description'] %></p>
          <% if c == 'ChecklistTest' %>
            <% if @product.product_tests.checklist_tests.exists? %>
              <%= button_to 'Perform Inspection', "/products/#{@product.id}/checklist_tests/#{@product.product_tests.checklist_tests.first.id}", class: 'btn btn-primary', method: :get %>
              The <%= certification_test['title'] %> is <%= @product.product_tests.checklist_tests.first.status %>.
            <% else %>
              <%= button_to 'Generate Test', "/products/#{@product.id}/checklist_tests", class: 'btn btn-primary', method: :post %>
            <% end %>
          <% elsif c == 'FilteringTest' %>
            <% if @product.product_tests.filtering_tests.exists? %>
              The <%= certification_test['title'] %> is <%= @product.product_tests.filtering_tests.first.status %>.
            <% else %>
              <%= button_to "Generate C4 Tests", new_vendor_product_filtering_test_path(product_id: @product._id), class: 'btn btn-primary', method: :get %>
            <% end %>
          <% else %>
            <%= render partial: 'measure_tests_table', locals: { tests: @product.product_tests.measure_tests } %>
          <% end %>
        </div>
      <% end %>
    <% end %>
  </div>
</div>
